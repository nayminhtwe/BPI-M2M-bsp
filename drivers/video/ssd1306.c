#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/module.h>
#include <linux/slab.h>
#include <linux/jiffies.h>
#include <linux/i2c.h>
#include <linux/mutex.h>
#include <linux/fs.h>
#include <asm/uaccess.h>

#include <mach/hardware.h>
#include <mach/sys_config.h>
#include <linux/init-input.h>
#include <linux/gpio.h>
#include <linux/regulator/consumer.h>
#include <linux/pinctrl/pinconf-sunxi.h>
#include <linux/pinctrl/consumer.h>

#define SSD1306_CMD    0
#define SSD1306_DAT    1

#define SSD1306_WIDTH    128
#define SSD1306_HEIGHT  64
#define SSD1306_NAME "ssd1306"

struct ssd1306_info {
	struct i2c_client *client;
	unsigned char twi_id;
	struct gpio_config oled_res;
	struct gpio_config oled_en;
	char *power;
};

struct ssd1306_info *ssd1306_client;
static uint8_t s_chDispalyBuffer[128][8];

const uint8_t c_chFont1608[95][16] = {
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*" ",0 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x1F, 0xCC, 0x00, 0x0C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*"!",1 */
	{0x00, 0x00, 0x08, 0x00, 0x30, 0x00,
	0x60, 0x00, 0x08, 0x00, 0x30, 0x00,
	0x60, 0x00, 0x00, 0x00},	/*""",2 */
	{0x02, 0x20, 0x03, 0xFC, 0x1E, 0x20,
	0x02, 0x20, 0x03, 0xFC, 0x1E, 0x20,
	0x02, 0x20, 0x00, 0x00},	/*"#",3 */
	{0x00, 0x00, 0x0E, 0x18, 0x11, 0x04,
	0x3F, 0xFF, 0x10, 0x84, 0x0C, 0x78,
	0x00, 0x00, 0x00, 0x00},	/*"$",4 */
	{0x0F, 0x00, 0x10, 0x84, 0x0F, 0x38,
	0x00, 0xC0, 0x07, 0x78, 0x18, 0x84,
	0x00, 0x78, 0x00, 0x00},	/*"%",5 */
	{0x00, 0x78, 0x0F, 0x84, 0x10, 0xC4,
	0x11, 0x24, 0x0E, 0x98, 0x00, 0xE4,
	0x00, 0x84, 0x00, 0x08},	/*"&",6 */
	{0x08, 0x00, 0x68, 0x00, 0x70, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*"'",7 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x07, 0xE0, 0x18, 0x18, 0x20, 0x04,
	0x40, 0x02, 0x00, 0x00},	/*"(",8 */
	{0x00, 0x00, 0x40, 0x02, 0x20, 0x04,
	0x18, 0x18, 0x07, 0xE0, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*")",9 */
	{0x02, 0x40, 0x02, 0x40, 0x01, 0x80,
	0x0F, 0xF0, 0x01, 0x80, 0x02, 0x40,
	0x02, 0x40, 0x00, 0x00},	/*"*",10 */
	{0x00, 0x80, 0x00, 0x80, 0x00, 0x80,
	0x0F, 0xF8, 0x00, 0x80, 0x00, 0x80,
	0x00, 0x80, 0x00, 0x00},	/*"+",11 */
	{0x00, 0x01, 0x00, 0x0D, 0x00, 0x0E,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*",",12 */
	{0x00, 0x00, 0x00, 0x80, 0x00, 0x80,
	0x00, 0x80, 0x00, 0x80, 0x00, 0x80,
	0x00, 0x80, 0x00, 0x80},	/*"-",13 */
	{0x00, 0x00, 0x00, 0x0C, 0x00, 0x0C,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*".",14 */
	{0x00, 0x00, 0x00, 0x06, 0x00, 0x18,
	0x00, 0x60, 0x01, 0x80, 0x06, 0x00,
	0x18, 0x00, 0x20, 0x00},	/*"/",15 */
	{0x00, 0x00, 0x07, 0xF0, 0x08, 0x08,
	0x10, 0x04, 0x10, 0x04, 0x08, 0x08,
	0x07, 0xF0, 0x00, 0x00},	/*"0",16 */
	{0x00, 0x00, 0x08, 0x04, 0x08, 0x04,
	0x1F, 0xFC, 0x00, 0x04, 0x00, 0x04,
	0x00, 0x00, 0x00, 0x00},	/*"1",17 */
	{0x00, 0x00, 0x0E, 0x0C, 0x10, 0x14,
	0x10, 0x24, 0x10, 0x44, 0x11, 0x84,
	0x0E, 0x0C, 0x00, 0x00},	/*"2",18 */
	{0x00, 0x00, 0x0C, 0x18, 0x10, 0x04,
	0x11, 0x04, 0x11, 0x04, 0x12, 0x88,
	0x0C, 0x70, 0x00, 0x00},	/*"3",19 */
	{0x00, 0x00, 0x00, 0xE0, 0x03, 0x20,
	0x04, 0x24, 0x08, 0x24, 0x1F, 0xFC,
	0x00, 0x24, 0x00, 0x00},	/*"4",20 */
	{0x00, 0x00, 0x1F, 0x98, 0x10, 0x84,
	0x11, 0x04, 0x11, 0x04, 0x10, 0x88,
	0x10, 0x70, 0x00, 0x00},	/*"5",21 */
	{0x00, 0x00, 0x07, 0xF0, 0x08, 0x88,
	0x11, 0x04, 0x11, 0x04, 0x18, 0x88,
	0x00, 0x70, 0x00, 0x00},	/*"6",22 */
	{0x00, 0x00, 0x1C, 0x00, 0x10, 0x00,
	0x10, 0xFC, 0x13, 0x00, 0x1C, 0x00,
	0x10, 0x00, 0x00, 0x00},	/*"7",23 */
	{0x00, 0x00, 0x0E, 0x38, 0x11, 0x44,
	0x10, 0x84, 0x10, 0x84, 0x11, 0x44,
	0x0E, 0x38, 0x00, 0x00},	/*"8",24 */
	{0x00, 0x00, 0x07, 0x00, 0x08, 0x8C,
	0x10, 0x44, 0x10, 0x44, 0x08, 0x88,
	0x07, 0xF0, 0x00, 0x00},	/*"9",25 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x03, 0x0C, 0x03, 0x0C, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*":",26 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
	0x01, 0x06, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*";",27 */
	{0x00, 0x00, 0x00, 0x80, 0x01, 0x40,
	0x02, 0x20, 0x04, 0x10, 0x08, 0x08,
	0x10, 0x04, 0x00, 0x00},	/*"<",28 */
	{0x02, 0x20, 0x02, 0x20, 0x02, 0x20,
	0x02, 0x20, 0x02, 0x20, 0x02, 0x20,
	0x02, 0x20, 0x00, 0x00},	/*"=",29 */
	{0x00, 0x00, 0x10, 0x04, 0x08, 0x08,
	0x04, 0x10, 0x02, 0x20, 0x01, 0x40,
	0x00, 0x80, 0x00, 0x00},	/*">",30 */
	{0x00, 0x00, 0x0E, 0x00, 0x12, 0x00,
	0x10, 0x0C, 0x10, 0x6C, 0x10, 0x80,
	0x0F, 0x00, 0x00, 0x00},	/*"?",31 */
	{0x03, 0xE0, 0x0C, 0x18, 0x13, 0xE4,
	0x14, 0x24, 0x17, 0xC4, 0x08, 0x28,
	0x07, 0xD0, 0x00, 0x00},	/*"@",32 */
	{0x00, 0x04, 0x00, 0x3C, 0x03, 0xC4,
	0x1C, 0x40, 0x07, 0x40, 0x00, 0xE4,
	0x00, 0x1C, 0x00, 0x04},	/*"A",33 */
	{0x10, 0x04, 0x1F, 0xFC, 0x11, 0x04,
	0x11, 0x04, 0x11, 0x04, 0x0E, 0x88,
	0x00, 0x70, 0x00, 0x00},	/*"B",34 */
	{0x03, 0xE0, 0x0C, 0x18, 0x10, 0x04,
	0x10, 0x04, 0x10, 0x04, 0x10, 0x08,
	0x1C, 0x10, 0x00, 0x00},	/*"C",35 */
	{0x10, 0x04, 0x1F, 0xFC, 0x10, 0x04,
	0x10, 0x04, 0x10, 0x04, 0x08, 0x08,
	0x07, 0xF0, 0x00, 0x00},	/*"D",36 */
	{0x10, 0x04, 0x1F, 0xFC, 0x11, 0x04,
	0x11, 0x04, 0x17, 0xC4, 0x10, 0x04,
	0x08, 0x18, 0x00, 0x00},	/*"E",37 */
	{0x10, 0x04, 0x1F, 0xFC, 0x11, 0x04,
	0x11, 0x00, 0x17, 0xC0, 0x10, 0x00,
	0x08, 0x00, 0x00, 0x00},	/*"F",38 */
	{0x03, 0xE0, 0x0C, 0x18, 0x10, 0x04,
	0x10, 0x04, 0x10, 0x44, 0x1C, 0x78,
	0x00, 0x40, 0x00, 0x00},	/*"G",39 */
	{0x10, 0x04, 0x1F, 0xFC, 0x10, 0x84,
	0x00, 0x80, 0x00, 0x80, 0x10, 0x84,
	0x1F, 0xFC, 0x10, 0x04},	/*"H",40 */
	{0x00, 0x00, 0x10, 0x04, 0x10, 0x04,
	0x1F, 0xFC, 0x10, 0x04, 0x10, 0x04,
	0x00, 0x00, 0x00, 0x00},	/*"I",41 */
	{0x00, 0x03, 0x00, 0x01, 0x10, 0x01,
	0x10, 0x01, 0x1F, 0xFE, 0x10, 0x00,
	0x10, 0x00, 0x00, 0x00},	/*"J",42 */
	{0x10, 0x04, 0x1F, 0xFC, 0x11, 0x04,
	0x03, 0x80, 0x14, 0x64, 0x18, 0x1C,
	0x10, 0x04, 0x00, 0x00},	/*"K",43 */
	{0x10, 0x04, 0x1F, 0xFC, 0x10, 0x04,
	0x00, 0x04, 0x00, 0x04, 0x00, 0x04,
	0x00, 0x0C, 0x00, 0x00},	/*"L",44 */
	{0x10, 0x04, 0x1F, 0xFC, 0x1F, 0x00,
	0x00, 0xFC, 0x1F, 0x00, 0x1F, 0xFC,
	0x10, 0x04, 0x00, 0x00},	/*"M",45 */
	{0x10, 0x04, 0x1F, 0xFC, 0x0C, 0x04,
	0x03, 0x00, 0x00, 0xE0, 0x10, 0x18,
	0x1F, 0xFC, 0x10, 0x00},	/*"N",46 */
	{0x07, 0xF0, 0x08, 0x08, 0x10, 0x04,
	0x10, 0x04, 0x10, 0x04, 0x08, 0x08,
	0x07, 0xF0, 0x00, 0x00},	/*"O",47 */
	{0x10, 0x04, 0x1F, 0xFC, 0x10, 0x84,
	0x10, 0x80, 0x10, 0x80, 0x10, 0x80,
	0x0F, 0x00, 0x00, 0x00},	/*"P",48 */
	{0x07, 0xF0, 0x08, 0x18, 0x10, 0x24,
	0x10, 0x24, 0x10, 0x1C, 0x08, 0x0A,
	0x07, 0xF2, 0x00, 0x00},	/*"Q",49 */
	{0x10, 0x04, 0x1F, 0xFC, 0x11, 0x04,
	0x11, 0x00, 0x11, 0xC0, 0x11, 0x30,
	0x0E, 0x0C, 0x00, 0x04},	/*"R",50 */
	{0x00, 0x00, 0x0E, 0x1C, 0x11, 0x04,
	0x10, 0x84, 0x10, 0x84, 0x10, 0x44,
	0x1C, 0x38, 0x00, 0x00},	/*"S",51 */
	{0x18, 0x00, 0x10, 0x00, 0x10, 0x04,
	0x1F, 0xFC, 0x10, 0x04, 0x10, 0x00,
	0x18, 0x00, 0x00, 0x00},	/*"T",52 */
	{0x10, 0x00, 0x1F, 0xF8, 0x10, 0x04,
	0x00, 0x04, 0x00, 0x04, 0x10, 0x04,
	0x1F, 0xF8, 0x10, 0x00},	/*"U",53 */
	{0x10, 0x00, 0x1E, 0x00, 0x11, 0xE0,
	0x00, 0x1C, 0x00, 0x70, 0x13, 0x80,
	0x1C, 0x00, 0x10, 0x00},	/*"V",54 */
	{0x1F, 0xC0, 0x10, 0x3C, 0x00, 0xE0,
	0x1F, 0x00, 0x00, 0xE0, 0x10, 0x3C,
	0x1F, 0xC0, 0x00, 0x00},	/*"W",55 */
	{0x10, 0x04, 0x18, 0x0C, 0x16, 0x34,
	0x01, 0xC0, 0x01, 0xC0, 0x16, 0x34,
	0x18, 0x0C, 0x10, 0x04},	/*"X",56 */
	{0x10, 0x00, 0x1C, 0x00, 0x13, 0x04,
	0x00, 0xFC, 0x13, 0x04, 0x1C, 0x00,
	0x10, 0x00, 0x00, 0x00},	/*"Y",57 */
	{0x08, 0x04, 0x10, 0x1C, 0x10, 0x64,
	0x10, 0x84, 0x13, 0x04, 0x1C, 0x04,
	0x10, 0x18, 0x00, 0x00},	/*"Z",58 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x7F, 0xFE, 0x40, 0x02, 0x40, 0x02,
	0x40, 0x02, 0x00, 0x00},	/*"[",59 */
	{0x00, 0x00, 0x30, 0x00, 0x0C, 0x00,
	0x03, 0x80, 0x00, 0x60, 0x00, 0x1C,
	0x00, 0x03, 0x00, 0x00},	/*"\",60 */
	{0x00, 0x00, 0x40, 0x02, 0x40, 0x02,
	0x40, 0x02, 0x7F, 0xFE, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*"]",61 */
	{0x00, 0x00, 0x00, 0x00, 0x20, 0x00,
	0x40, 0x00, 0x40, 0x00, 0x40, 0x00,
	0x20, 0x00, 0x00, 0x00},	/*"^",62 */
	{0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
	0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
	0x00, 0x01, 0x00, 0x01},	/*"_",63 */
	{0x00, 0x00, 0x40, 0x00, 0x40, 0x00,
	0x20, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*"`",64 */
	{0x00, 0x00, 0x00, 0x98, 0x01, 0x24,
	0x01, 0x44, 0x01, 0x44, 0x01, 0x44,
	0x00, 0xFC, 0x00, 0x04},	/*"a",65 */
	{0x10, 0x00, 0x1F, 0xFC, 0x00, 0x88,
	0x01, 0x04, 0x01, 0x04, 0x00, 0x88,
	0x00, 0x70, 0x00, 0x00},	/*"b",66 */
	{0x00, 0x00, 0x00, 0x70, 0x00, 0x88,
	0x01, 0x04, 0x01, 0x04, 0x01, 0x04,
	0x00, 0x88, 0x00, 0x00},	/*"c",67 */
	{0x00, 0x00, 0x00, 0x70, 0x00, 0x88,
	0x01, 0x04, 0x01, 0x04, 0x11, 0x08,
	0x1F, 0xFC, 0x00, 0x04},	/*"d",68 */
	{0x00, 0x00, 0x00, 0xF8, 0x01, 0x44,
	0x01, 0x44, 0x01, 0x44, 0x01, 0x44,
	0x00, 0xC8, 0x00, 0x00},	/*"e",69 */
	{0x00, 0x00, 0x01, 0x04, 0x01, 0x04,
	0x0F, 0xFC, 0x11, 0x04, 0x11, 0x04,
	0x11, 0x00, 0x18, 0x00},	/*"f",70 */
	{0x00, 0x00, 0x00, 0xD6, 0x01, 0x29,
	0x01, 0x29, 0x01, 0x29, 0x01, 0xC9,
	0x01, 0x06, 0x00, 0x00},	/*"g",71 */
	{0x10, 0x04, 0x1F, 0xFC, 0x00, 0x84,
	0x01, 0x00, 0x01, 0x00, 0x01, 0x04,
	0x00, 0xFC, 0x00, 0x04},	/*"h",72 */
	{0x00, 0x00, 0x01, 0x04, 0x19, 0x04,
	0x19, 0xFC, 0x00, 0x04, 0x00, 0x04,
	0x00, 0x00, 0x00, 0x00},	/*"i",73 */
	{0x00, 0x00, 0x00, 0x03, 0x00, 0x01,
	0x01, 0x01, 0x19, 0x01, 0x19, 0xFE,
	0x00, 0x00, 0x00, 0x00},	/*"j",74 */
	{0x10, 0x04, 0x1F, 0xFC, 0x00, 0x24,
	0x00, 0x40, 0x01, 0xB4, 0x01, 0x0C,
	0x01, 0x04, 0x00, 0x00},	/*"k",75 */
	{0x00, 0x00, 0x10, 0x04, 0x10, 0x04,
	0x1F, 0xFC, 0x00, 0x04, 0x00, 0x04,
	0x00, 0x00, 0x00, 0x00},	/*"l",76 */
	{0x01, 0x04, 0x01, 0xFC, 0x01, 0x04,
	0x01, 0x00, 0x01, 0xFC, 0x01, 0x04,
	0x01, 0x00, 0x00, 0xFC},	/*"m",77 */
	{0x01, 0x04, 0x01, 0xFC, 0x00, 0x84,
	0x01, 0x00, 0x01, 0x00, 0x01, 0x04,
	0x00, 0xFC, 0x00, 0x04},	/*"n",78 */
	{0x00, 0x00, 0x00, 0xF8, 0x01, 0x04,
	0x01, 0x04, 0x01, 0x04, 0x01, 0x04,
	0x00, 0xF8, 0x00, 0x00},	/*"o",79 */
	{0x01, 0x01, 0x01, 0xFF, 0x00, 0x85,
	0x01, 0x04, 0x01, 0x04, 0x00, 0x88,
	0x00, 0x70, 0x00, 0x00},	/*"p",80 */
	{0x00, 0x00, 0x00, 0x70, 0x00, 0x88,
	0x01, 0x04, 0x01, 0x04, 0x01, 0x05,
	0x01, 0xFF, 0x00, 0x01},	/*"q",81 */
	{0x01, 0x04, 0x01, 0x04, 0x01, 0xFC,
	0x00, 0x84, 0x01, 0x04, 0x01, 0x00,
	0x01, 0x80, 0x00, 0x00},	/*"r",82 */
	{0x00, 0x00, 0x00, 0xCC, 0x01, 0x24,
	0x01, 0x24, 0x01, 0x24, 0x01, 0x24,
	0x01, 0x98, 0x00, 0x00},	/*"s",83 */
	{0x00, 0x00, 0x01, 0x00, 0x01, 0x00,
	0x07, 0xF8, 0x01, 0x04, 0x01, 0x04,
	0x00, 0x00, 0x00, 0x00},	/*"t",84 */
	{0x01, 0x00, 0x01, 0xF8, 0x00, 0x04,
	0x00, 0x04, 0x00, 0x04, 0x01, 0x08,
	0x01, 0xFC, 0x00, 0x04},	/*"u",85 */
	{0x01, 0x00, 0x01, 0x80, 0x01, 0x70,
	0x00, 0x0C, 0x00, 0x10, 0x01, 0x60,
	0x01, 0x80, 0x01, 0x00},	/*"v",86 */
	{0x01, 0xF0, 0x01, 0x0C, 0x00, 0x30,
	0x01, 0xC0, 0x00, 0x30, 0x01, 0x0C,
	0x01, 0xF0, 0x01, 0x00},	/*"w",87 */
	{0x00, 0x00, 0x01, 0x04, 0x01, 0x8C,
	0x00, 0x74, 0x01, 0x70, 0x01, 0x8C,
	0x01, 0x04, 0x00, 0x00},	/*"x",88 */
	{0x01, 0x01, 0x01, 0x81, 0x01, 0x71,
	0x00, 0x0E, 0x00, 0x18, 0x01, 0x60,
	0x01, 0x80, 0x01, 0x00},	/*"y",89 */
	{0x00, 0x00, 0x01, 0x84, 0x01, 0x0C,
	0x01, 0x34, 0x01, 0x44, 0x01, 0x84,
	0x01, 0x0C, 0x00, 0x00},	/*"z",90 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x3E, 0xFC,
	0x40, 0x02, 0x40, 0x02},	/*"{",91 */
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*"|",92 */
	{0x00, 0x00, 0x40, 0x02, 0x40, 0x02,
	0x3E, 0xFC, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00},	/*"}",93 */
	{0x00, 0x00, 0x60, 0x00, 0x80, 0x00,
	0x80, 0x00, 0x40, 0x00, 0x40, 0x00,
	0x20, 0x00, 0x20, 0x00},	/*"~",94 */
};

static unsigned short normal_i2c[] = { 0x3C,
	I2C_CLIENT_END };

static const struct i2c_device_id ssd1306_id[] = {
	{SSD1306_NAME, 0},
	{}
};

static int ssd1306_detect(struct i2c_client *client,
		struct i2c_board_info *info);
static int ssd1306_probe(struct i2c_client *client,
		const struct i2c_device_id *id);
static int __devexit ssd1306_remove(struct i2c_client *client);

int sunxi_ssd_gpio_req(struct gpio_config *gpio)
{
	int ret = 0;
	char pin_name[8] = { 0 };
	unsigned long config;

	sunxi_gpio_to_name(gpio->gpio, pin_name);
	pr_info("name:%s, pull%d, level%d, muxsel%d, index %d\n",
			pin_name, gpio->pull, gpio->drv_level,
			gpio->mul_sel, gpio->gpio);

	config = SUNXI_PINCFG_PACK(SUNXI_PINCFG_TYPE_FUNC,
			gpio->mul_sel);
	ret = pin_config_set(SUNXI_PINCTRL, pin_name, config);
	if (ret) {
		pr_err("set gpio %s mulsel failed.\n", pin_name);
		return -1;
	}

	if (gpio->pull != GPIO_PULL_DEFAULT) {
		config = SUNXI_PINCFG_PACK(SUNXI_PINCFG_TYPE_PUD,
				gpio->pull);
		ret = pin_config_set(SUNXI_PINCTRL, pin_name, config);
		if (ret) {
			pr_err("set gpio %s pull mode failed.\n", pin_name);
			return -1;
		}
	}

	if (gpio->drv_level != GPIO_DRVLVL_DEFAULT) {
		config = SUNXI_PINCFG_PACK(SUNXI_PINCFG_TYPE_DRV,
				gpio->drv_level);
		ret = pin_config_set(SUNXI_PINCTRL, pin_name, config);
		if (ret) {
			pr_err("set %s driver level failed.\n", pin_name);
			return -1;
		}
	}

	if (gpio->data != GPIO_DATA_DEFAULT) {
		config = SUNXI_PINCFG_PACK(SUNXI_PINCFG_TYPE_DAT,
				gpio->data);
		ret = pin_config_set(SUNXI_PINCTRL, pin_name, config);
		if (ret) {
			pr_err("set %s val failed.\n", pin_name);
			return -1;
		}
	}

	return 0;
}

int oled_power_enable(char *name)
{
	struct regulator *regu = NULL;
	int ret = 0;
	regu = regulator_get(NULL, name);
	if (IS_ERR(regu)) {
		pr_err("fail get regulator %s\n", name);
		goto exit;
	}

	/*enalbe regulator */
	ret = regulator_enable(regu);
	if (0 != ret) {
		pr_err("fail enable regulator %s!\n", name);
		goto exit1;
	} else {
		pr_info("suceess enable regulator %s!\n", name);
	}

exit1:
	/*put regulater, when module exit */
	regulator_put(regu);
exit:
	return ret;
}

int oled_power_disable(char *name)
{
	struct regulator *regu = NULL;
	int ret = 0;
	regu = regulator_get(NULL, name);
	if (IS_ERR(regu)) {
		pr_err("get regulator %s failed\n", name);
		goto exit;
	}

	/*disalbe regulator */
	ret = regulator_disable(regu);
	if (0 != ret) {
		pr_err("fail disable regulator %s!\n", name);
		goto exit1;
	} else
		pr_info("suceess disable regulator%s!\n", name);

exit1:
	/*put regulater, when module exit */
	regulator_put(regu);
exit:
	return ret;
}

static void ssd1306_write_byte(uint8_t chData, uint8_t chCmd)
{
	uint8_t cmd = 0x00;

	if (chCmd)
		cmd = 0x40;
	else
		cmd = 0x00;

	i2c_smbus_write_byte_data(ssd1306_client->client,
			cmd, chData);
}

void ssd1306_display_on(void)
{
	ssd1306_write_byte(0x8D, SSD1306_CMD);
	ssd1306_write_byte(0x14, SSD1306_CMD);
	ssd1306_write_byte(0xAF, SSD1306_CMD);
}

/**
  * @brief  OLED turns off
  *
  * @param  None
  *
  * @retval  None
**/
void ssd1306_display_off(void)
{
	ssd1306_write_byte(0x8D, SSD1306_CMD);
	ssd1306_write_byte(0x10, SSD1306_CMD);
	ssd1306_write_byte(0xAE, SSD1306_CMD);
}

void ssd1306_refresh_gram(void)
{
	uint8_t i, j;

	for (i = 0; i < 8; i++) {
		ssd1306_write_byte(0xB0 + i, SSD1306_CMD);
		ssd1306_write_byte(0x02, SSD1306_CMD);
		ssd1306_write_byte(0x10, SSD1306_CMD);
		for (j = 0; j < 128; j++) {
			ssd1306_write_byte(s_chDispalyBuffer[j][i],
					SSD1306_DAT);
		}
	}
}

void ssd1306_clear_screen(uint8_t chFill)
{
	memset(s_chDispalyBuffer, chFill,
			sizeof(s_chDispalyBuffer));
	ssd1306_refresh_gram();
}

/**
  * @brief  Draws a piont on the screen
  *
  * @param  chXpos: Specifies the X position
  * @param  chYpos: Specifies the Y position
  * @param  chPoint: 0: the point turns off
  * 1: the piont turns on
  *
  * @retval None
**/

void ssd1306_draw_point(uint8_t chXpos,
		uint8_t chYpos, uint8_t chPoint)
{
	uint8_t chPos, chBx, chTemp = 0;

	if (chXpos > 127 || chYpos > 63)
		return;

	chPos = 7 - chYpos / 8;
	chBx = chYpos % 8;
	chTemp = 1 << (7 - chBx);

	if (chPoint)
		s_chDispalyBuffer[chXpos][chPos] |= chTemp;
	else
		s_chDispalyBuffer[chXpos][chPos] &= ~chTemp;
}

/**
  * @brief  Fills a rectangle
  *
  * @param chXpos1: Specifies the X position 1
  * (X top left position)
  * @param chYpos1: Specifies the Y position 1
  * (Y top left position)
  * @param chXpos2: Specifies the X position 2
  * (X bottom right position)
  * @param chYpos3: Specifies the Y position 2
  * (Y bottom right position)
  *
  * @retval
**/

void ssd1306_fill_screen(uint8_t chXpos1, uint8_t chYpos1,
		uint8_t chXpos2, uint8_t chYpos2, uint8_t chDot)
{
	uint8_t chXpos, chYpos;

	for (chXpos = chXpos1; chXpos <= chXpos2; chXpos++)
		for (chYpos = chYpos1; chYpos <= chYpos2; chYpos++)
			ssd1306_draw_point(chXpos, chYpos, chDot);

	ssd1306_refresh_gram();
}

/**
  * @brief Displays one character at the specified position
  *
  * @param  chXpos: Specifies the X position
  * @param  chYpos: Specifies the Y position
  * @param  chSize:
  * @param  chMode
  * @retval
**/
void ssd1306_display_char(uint8_t chXpos, uint8_t chYpos,
		uint8_t chChr, uint8_t chSize, uint8_t chMode)
{
	uint8_t i, j;
	uint8_t chTemp, chYpos0 = chYpos;

	chChr = chChr - ' ';
	for (i = 0; i < chSize; i++) {
		if (chMode)
			chTemp = c_chFont1608[chChr][i];
		else
			chTemp = ~c_chFont1608[chChr][i];

		for (j = 0; j < 8; j++) {
			if (chTemp & 0x80)
				ssd1306_draw_point(chXpos, chYpos, 1);
			else
				ssd1306_draw_point(chXpos, chYpos, 0);
			chTemp <<= 1;
			chYpos++;

			if ((chYpos - chYpos0) == chSize) {
				chYpos = chYpos0;
				chXpos++;
				break;
			}
		}
	}
}

/**
  * @brief  Displays a string on the screen
  *
  * @param  chXpos: Specifies the X position
  * @param  chYpos: Specifies the Y position
  * @param  pchString: Pointer to a string
  * to display on the screen
  *
  * @retval  None
**/
void ssd1306_display_string(uint8_t chXpos, uint8_t chYpos,
	const uint8_t *pchString, uint8_t chSize, uint8_t chMode)
{
	while (*pchString != '\0') {
		if (chXpos > (SSD1306_WIDTH - chSize / 2)) {
			chXpos = 0;
			chYpos += chSize;
			if (chYpos > (SSD1306_HEIGHT - chSize)) {
				chYpos = chXpos = 0;
				ssd1306_clear_screen(0x00);
			}
		}

		ssd1306_display_char(chXpos, chYpos,
				*pchString, chSize, chMode);
		chXpos += chSize / 2;
		pchString++;
	}
}

void ssd1306_init(void)
{
	ssd1306_write_byte(0xAE, SSD1306_CMD);
	/* turn off oled panel */
	ssd1306_write_byte(0x00, SSD1306_CMD);
	/* set low column address */
	ssd1306_write_byte(0x10, SSD1306_CMD);
	/* set high column address */
	ssd1306_write_byte(0x40, SSD1306_CMD);
	/* set start line address
	Set Mapping RAM Display Start Line (0x00~0x3F) */
	ssd1306_write_byte(0x81, SSD1306_CMD);
	/* set contrast control register */
	ssd1306_write_byte(0xCF, SSD1306_CMD);
	/* Set SEG Output Current Brightness */
	ssd1306_write_byte(0xA1, SSD1306_CMD);
	/* Set SEG/Column Mapping */
	ssd1306_write_byte(0xC0, SSD1306_CMD);
	/* Set COM/Row Scan Direction */
	ssd1306_write_byte(0xA6, SSD1306_CMD);
	/* set normal display */
	ssd1306_write_byte(0xA8, SSD1306_CMD);
	/* set multiplex ratio(1 to 64) */
	ssd1306_write_byte(0x3f, SSD1306_CMD);
	/* 1/64 duty */
	/* set display offset Shift Mapping
	 * RAM Counter (0x00~0x3F) */
	ssd1306_write_byte(0xD3, SSD1306_CMD);
	ssd1306_write_byte(0x00, SSD1306_CMD);
	/* not offset */
	/* set display clock divide
	 * ratio/oscillator frequency */
	ssd1306_write_byte(0xd5, SSD1306_CMD);
	/* set divide ratio, Set Clock as 100
	 * Frames/Sec */
	ssd1306_write_byte(0x80, SSD1306_CMD);
	ssd1306_write_byte(0xD9, SSD1306_CMD);
	/* set pre-charge period */
	/* Set Pre-Charge as 15 Clocks & Discharge
	 * as 1 Clock */
	ssd1306_write_byte(0xF1, SSD1306_CMD);
	ssd1306_write_byte(0xDA, SSD1306_CMD);
	/* set com pins hardware configuration */
	ssd1306_write_byte(0x12, SSD1306_CMD);
	ssd1306_write_byte(0xDB, SSD1306_CMD);
	/* set vcomh */
	ssd1306_write_byte(0x40, SSD1306_CMD);
	/* Set VCOM Deselect Level */
	ssd1306_write_byte(0x20, SSD1306_CMD);
	/* Set Page Addressing Mode(0x00/0x01/0x02)*/
	ssd1306_write_byte(0x02, SSD1306_CMD);
	ssd1306_write_byte(0x8D, SSD1306_CMD);
	/* set Charge Pump enable/disable */
	ssd1306_write_byte(0x14, SSD1306_CMD);
	/* set(0x10) disable */
	ssd1306_write_byte(0xA4, SSD1306_CMD);
	/* Disable Entire Display On (0xa4/0xa5) */
	ssd1306_write_byte(0xA6, SSD1306_CMD);
	/* Disable Inverse Display On (0xa6/a7) */
	ssd1306_write_byte(0xAF, SSD1306_CMD);
	/* turn on oled panel */

	ssd1306_display_on();
	ssd1306_clear_screen(0xff);
}

static int ssd1306_detect(struct i2c_client *client,
		struct i2c_board_info *info)
{
	pr_info("ssd1306_detect\n");
	strlcpy(info->type, SSD1306_NAME, I2C_NAME_SIZE);
	return 0;
}

static struct i2c_driver ssd1306_driver = {
	.class = I2C_CLASS_HWMON,
	.driver = {
		   .name = SSD1306_NAME,
		   .owner = THIS_MODULE,
		   },
	.probe = ssd1306_probe,
	.remove = __devexit_p(ssd1306_remove),
	.id_table = ssd1306_id,
	.detect = ssd1306_detect,
	.address_list = normal_i2c,
};

static int ssd1306_probe(struct i2c_client *client,
		const struct i2c_device_id *id)
{
	pr_info("ssd1306 probe\n");
	if (ssd1306_client->twi_id ==
			client->adapter->nr) {
		ssd1306_client->client = client;

		sunxi_ssd_gpio_req(&ssd1306_client->oled_en);
		sunxi_ssd_gpio_req(&ssd1306_client->oled_res);
		oled_power_enable(ssd1306_client->power);

		ssd1306_init();

		ssd1306_clear_screen(0x00);
		ssd1306_display_off();

		ssd1306_display_string(18, 0, "hello,Linux!",
				16, 1);
		ssd1306_display_string(0, 16,
				"it is i2c OLED driver demo!", 16, 1);
		ssd1306_refresh_gram();
		ssd1306_display_on();

		return 0;
	}

	return -ENODEV;
}

static int __devexit ssd1306_remove(struct i2c_client *client)
{
	pr_info("ssd1306_remove\n");

	ssd1306_display_off();
	ssd1306_clear_screen(0x00);

	oled_power_disable(ssd1306_client->power);

	return 0;
}

static int oled_fetch_sysconfig_para(void)
{
	int ret = -1;
	int device_used = -1;
	script_item_u val;
	script_item_value_type_e type;

	pr_info("step1: oled_fetch_sysconfig_para\n");
	type = script_get_item("oled_para",
			"oled_used", &val);
	if (SCIRPT_ITEM_VALUE_TYPE_INT != type) {
		pr_err("%s: oled not used [%d] !!\n",
				__func__, val.val);
		goto script_get_err;
	}
	device_used = val.val;

	if (1 == device_used) {
		type = script_get_item("oled_para",
				"oled_twi_id", &val);
		if (SCIRPT_ITEM_VALUE_TYPE_INT != type) {
			pr_err("oled has no i2c bus[%d]\n", val.val);
			goto script_get_err;
		}
		ssd1306_client->twi_id = val.val;
		pr_info("twi_id is %d.\n", ssd1306_client->twi_id);

		type = script_get_item("oled_para", "oled_res", &val);
		if (SCIRPT_ITEM_VALUE_TYPE_PIO != type) {
			pr_err("oled get reset gpio failed\n");
			goto script_get_err;
		}

		memcpy(&ssd1306_client->oled_res, &val.gpio,
				sizeof(struct gpio_config));

		type = script_get_item("oled_para", "oled_en", &val);
		if (SCIRPT_ITEM_VALUE_TYPE_PIO != type) {
			pr_err("%s: oled get reset gpio failed\n",
					__func__);
			goto script_get_err;
		}
		memcpy(&ssd1306_client->oled_en, &val.gpio,
				sizeof(struct gpio_config));

		type = script_get_item("oled_para",
				"oled_power", &val);
		if (SCIRPT_ITEM_VALUE_TYPE_STR != type) {
			pr_err("failed to fetch oled power\n");
		} else {
			ssd1306_client->power = val.str;
			pr_info("oled power name %s\n",
					ssd1306_client->power);
		}
		ret = 0;
	} else {
		ret = -1;
	}

	return ret;

script_get_err:
	pr_err("script_parser_fetch_err!!\n");
	return ret;
}

static int ssd1306_module_init(void)
{
	ssd1306_client = kzalloc(sizeof(struct ssd1306_info),
			GFP_KERNEL);
	oled_fetch_sysconfig_para();

	i2c_add_driver(&ssd1306_driver);
	return 0;
}

static void ssd1306_module_exit(void)
{
	i2c_del_driver(&ssd1306_driver);
	kfree(ssd1306_client);
}

module_init(ssd1306_module_init);
module_exit(ssd1306_module_exit);

MODULE_LICENSE("GPL");
